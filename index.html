<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MAKA FastCharging</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

    <!-- Leaflet (map lib) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-sA+g6kGk3YkNf3w9xv0fXq6s1QmDgQ1p2v9g9+v+0uc=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-o9N1j8k78+gCkz+4nq6E8GQ3rVh5s1qD+6v9m2mY5nM=" crossorigin=""></script>

    <style>
        :root {
            --bg: #050505;
            --card: #111;
            --card-border: #222;
            --accent: #CCFF00; /* Kuning Stabilo */
            --cyan: #00d2ff;
            --danger: #FF3B30;
            --text: #ffffff;
            --text-mute: #888;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* LOADER */
        .loader { position: fixed; inset:0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        .loader-logo { width: 150px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(204, 255, 0, 0.3)); animation: floatLogo 3s infinite; }
        @keyframes floatLogo { 0%{transform:translateY(0)} 50%{transform:translateY(-10px)} 100%{transform:translateY(0)} }
        #animText1 { font-size: 1rem; color: var(--accent); margin-bottom: 5px; font-weight: 600; }
        #animText2 { font-family: 'Syne'; font-size: 1.8rem; font-weight: 800; color: #fff; text-transform: uppercase; margin-bottom: 30px; text-align: center; }
        .loader-actions { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; opacity: 0; transform: translateY(20px); transition: all 0.8s ease; }
        .loader-actions.show { opacity: 1; transform: translateY(0); }
        .btn-entry { padding: 15px; border-radius: 12px; font-weight: 800; text-transform: uppercase; border: none; width: 100%; cursor: pointer; }
        .btn-entry.primary { background: var(--accent); color: #000; }
        .btn-entry.danger { background: rgba(255,59,48,0.2); border: 1px solid var(--danger); color: var(--danger); }

        /* HEADER */
        .header { padding: 20px 25px 10px; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; position: relative; }
        .header-text { display: flex; flex-direction: column; }
        .label-top { font-size: 0.7rem; color: var(--text-mute); letter-spacing: 1px; font-weight: 700; margin-bottom: 5px; }
        .header h1 { font-family: 'Inter', sans-serif; font-size: 10vw; margin: 0; line-height: 0.9; font-weight: 900; letter-spacing: -1px; color: #fff; max-width: 70%; }
        .label-bottom { font-size: 0.75rem; color: var(--accent); letter-spacing: 1px; font-weight: 700; margin-top: 8px; }

        /* MENU KANAN ATAS */
        .top-menu { display: flex; gap: 10px; margin-top: 5px; }
        .menu-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid #333; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.2s; }
        .menu-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .menu-btn:active { transform: scale(0.9); background: var(--accent); color: #000; }
        .menu-btn.sos { border-color: var(--danger); color: var(--danger); }
        .menu-btn.sos:active { background: var(--danger); color: #fff; }

        /* HERO */
        .hero-section { padding: 10px 25px; margin-bottom: 20px; flex-shrink: 0; }
        .hero-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 24px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; min-height: 180px; justify-content: center; }
        .hero-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .radar-status { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; }
        .gps-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); animation: pulse 1s infinite; }
        @keyframes pulse { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }
        .hero-dist { background: rgba(0,0,0,0.6); border: 1px solid var(--accent); padding: 4px 10px; border-radius: 8px; font-family: 'Syne'; font-size: 0.9rem; font-weight: 700; color: var(--accent); }
        .hero-name { font-family: 'Inter', sans-serif; font-size: clamp(1.8rem, 8vw, 2.2rem); font-weight: 800; color: #fff; line-height: 1.1; margin-bottom: 5px; }
        .hero-info { font-size: 0.85rem; color: #aaa; margin-bottom: 20px; padding-left: 12px; border-left: 3px solid var(--accent); line-height: 1.5; }
        .btn-nav-hero { display: block; width: 100%; padding: 14px; background: var(--accent); color: #000; text-align: center; text-decoration: none; font-weight: 800; border-radius: 12px; font-size: 0.9rem; letter-spacing: 0.5px; box-shadow: 0 4px 20px rgba(204, 255, 0, 0.2); }

        /* LIST */
        .list-section { flex: 1; overflow-y: auto; padding-bottom: 50px; }
        .city-group { margin-bottom: 30px; }
        .city-header { padding: 0 25px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .city-title { color: var(--text); font-family: 'Syne'; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .city-line { height: 1px; background: #333; flex-grow: 1; }
        .h-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 0 25px; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .mini-card { min-width: 160px; width: 160px; height: 190px; border-radius: 18px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; scroll-snap-align: start; flex-shrink: 0; text-decoration: none; position: relative; overflow: hidden; transition: transform 0.2s; }
        .mini-card:active { transform: scale(0.95); }
        /* WARNA SELANG SELING */
        .style-1 { background: linear-gradient(145deg, #111, #1a1a1a); border: 1px solid #333; color: white; }
        .style-2 { background: linear-gradient(145deg, #022c22, #064e3b); border: 1px solid #065f46; color: #d1fae5; }
        .style-3 { background: linear-gradient(145deg, #0f172a, #1e293b); border: 1px solid #1e3a8a; color: #bfdbfe; }
        .bg-bolt { position: absolute; right: -10px; bottom: -20px; font-size: 5rem; opacity: 0.1; transform: rotate(-15deg); pointer-events: none; color: #fff; }
        .mini-top h3 { margin: 0 0 8px 0; font-size: 0.9rem; line-height: 1.3; font-weight: 700; color: inherit; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .mini-info { font-size: 0.7rem; opacity: 0.8; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; line-height: 1.4; z-index: 2; color: inherit; }
        .mini-dist { font-size: 0.85rem; font-weight: 800; z-index: 2; text-align: right; margin-top: 5px; color: var(--accent); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: #000; z-index: 2000; transform: translateY(100%); transition: 0.3s ease; display: flex; flex-direction: column; }
        .modal.show { transform: translateY(0); }
        .modal-head { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: #222; border: 1px solid #333; color: #fff; font-size: 0.8rem; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-foot { padding: 20px; border-top: 1px solid #222; background: #050505; }
        .btn-close-bot { width: 100%; padding: 15px; border-radius: 12px; background: #111; border: 1px solid #333; color: var(--accent); font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .help-row { background: #111; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; text-decoration: none; color: white; margin-bottom: 10px; border: 1px solid #222; }
        .news-item { margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        /* SLIDESHOW */
        .slide-container { width: 100%; aspect-ratio: 16/9; background: #111; border-radius: 12px; overflow: hidden; margin-bottom: 15px; display: flex; scroll-snap-type: x mandatory; overflow-x: scroll; scroll-behavior: smooth; scrollbar-width: none;}
        .slide-box-multi { min-width: 100%; height: 100%; scroll-snap-align: start; }
        .slide-box-multi img { width: 100%; height: 100%; object-fit: cover; }

        /* ====== Map overlay styles (minimal, non-intrusive) ====== */
        #mapOverlay {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: none; /* shown when needed */
            align-items: stretch;
            justify-content: center;
            background: rgba(0,0,0,0.6);
        }
        #mapPanel {
            width: 100%;
            max-width: 980px;
            height: 80vh;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: auto;
            position: relative;
            border: 1px solid #111;
        }
        #mapInner { width:100%; height:100%; }
        .map-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 9999;
            background: rgba(255,255,255,0.95);
            color: #000;
            padding: 8px 10px;
            border-radius: 10px;
            font-weight:700;
            cursor: pointer;
            border: none;
        }
        .map-open-gmap {
            position: absolute;
            bottom: 14px;
            left: 14px;
            z-index: 9999;
            background: rgba(255,255,255,0.95);
            color: #000;
            padding: 10px 12px;
            border-radius: 10px;
            font-weight:700;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }
        .map-title {
            position: absolute;
            top: 14px;
            left: 14px;
            z-index: 9999;
            background: rgba(0,0,0,0.4);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--accent);
            font-weight:800;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <img src="mlu-logo.png" alt="Logo" class="loader-logo">
        <div id="animText1">SELAMAT DATANG</div>
        <div id="animText2">SAHABAT MLU</div>
        <div id="animText3">â€¢ HOME OF MLU â€¢</div>
        <div class="loader-actions" id="loaderBtns">
            <button class="btn-entry primary" onclick="enterApp('home')">LOKASI FC âš¡</button>
            <button class="btn-entry danger" onclick="enterApp('sos')">BANTUAN SOS ðŸš¨</button>
        </div>
    </div>

    <div class="header">
        <div class="header-text">
            <div class="label-top">LOKASI</div>
            <h1>FAST<br>CHARGING</h1>
            <div class="label-bottom">MAKA LINTAS UTARA</div>
        </div>
        <div class="top-menu">
            <button class="menu-btn" onclick="nav('news')" title="Info">
                <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            </button>
            <button class="menu-btn sos" onclick="nav('sos')" title="SOS">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </button>
        </div>
    </div>

    <div class="hero-section">
        <div id="heroContainer">
            <div id="scanState" class="hero-card" style="align-items:center; text-align:center;">
                <div class="radar-status" style="justify-content:center; margin-bottom:15px;">
                    <div class="gps-dot"></div> MENCARI SINYAL GPS...
                </div>
                <p style="color:#666; font-size:0.8rem; margin:0;">Pastikan Lokasi/GPS HP Aktif</p>
            </div>

            <div id="foundState" class="hero-card" style="display:none;">
                <div class="hero-header">
                    <div class="radar-status"><div class="gps-dot"></div> FC TERDEKAT</div>
                    <div class="hero-dist" id="heroDist">-- KM</div>
                </div>
                <h2 class="hero-name" id="heroName">Nama Lokasi</h2>
                <div class="hero-info" id="heroInfo">Info Loading...</div>
                <a href="#" id="heroLink" target="_blank" class="btn-nav-hero">NAVIGASI SEKARANG â†—</a>
            </div>
        </div>
    </div>

    <div class="list-section" id="mainListContainer"></div>

    <div id="modal-news" class="modal">
        <div class="modal-head"><h2>INFO & EVENT</h2><button class="close-btn" onclick="closeModal()">TUTUP</button></div>
        <div class="modal-body" id="newsContainer"></div>
        <div class="modal-foot"><button class="btn-close-bot" onclick="closeModal()">KEMBALI KE HOME</button></div>
    </div>

    <div id="modal-sos" class="modal">
        <div class="modal-head"><h2 style="color:var(--danger);">DARURAT (SOS)</h2><button class="close-btn" onclick="closeModal()">TUTUP</button></div>
        <div class="modal-body">
            <p style="text-align:center; color:#888; margin-bottom:20px;">Klik untuk Chat WhatsApp:</p>
            <a href="https://wa.me/6287722285445" class="help-row"><div style="font-size:1.5rem;">ðŸš‘</div><div><div style="font-weight:700;">Towing / Unit Mogok</div></div></a>
            <a href="https://wa.me/6283179721893" class="help-row"><div style="font-size:1.5rem;">ðŸš¨</div><div><div style="font-weight:700;">URC Kecelakaan</div></div></a>
            <a href="https://wa.me/6285117468556" class="help-row"><div style="font-size:1.5rem;">ðŸ’³</div><div><div style="font-weight:700;">Admin Tagihan</div></div></a>
        </div>
        <div class="modal-foot"><button class="btn-close-bot" style="color:var(--danger); border-color:var(--danger);" onclick="closeModal()">TUTUP DARURAT</button></div>
    </div>

    <!-- MAP OVERLAY -->
    <div id="mapOverlay" aria-hidden="true">
        <div id="mapPanel" role="dialog" aria-label="Peta Lokasi">
            <div id="mapInner"></div>
            <div class="map-title" id="mapTitle">Navigasi</div>
            <button class="map-close-btn" id="mapCloseBtn" aria-label="Tutup peta">Tutup</button>
            <a id="openGmapBtn" class="map-open-gmap" target="_blank" rel="noopener">Buka di Google Maps</a>
        </div>
    </div>

    <script>
        const URL_LOKASI = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv"; 
        const URL_BERITA = "https://docs.google.com/spreadsheets/d/1qh_aKEQQvN0B1E6ONO0LGIpuQ6phzc-ALc4SduClMyY/export?format=csv"; 

        let chargers = [];
        let userLat = null; let userLng = null;

        // MAP vars
        let map = null;
        let destMarker = null;
        let userMarker = null;
        let markerLayer = null;
        const JAWG_TOKEN = "l1PdBwk1arfZcY7wECff2jE2Ts7qpJyMqGGqHK8cjCxcLb6m0FPHm1sExB5NvLyA"; // <- isi token kamu di sini (jawg-xxxxx). Jika kosong, fallback ke Carto Voyager

        function startApp() {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 500);
            loadDataBackground();
        }

        async function loadDataBackground() {
            try {
                const [txtLoc, txtNews] = await Promise.all([
                    fetch(URL_LOKASI).then(r=>r.text()),
                    fetch(URL_BERITA).then(r=>r.ok?r.text():"")
                ]);

                chargers = txtLoc.split('\n').slice(1).map((r, i) => {
                    const c = r.split(',');
                    let latStr = c[4] ? c[4].replace(',', '.') : '';
                    let lngStr = c[5] ? c[5].replace(',', '.') : '';
                    let latVal = parseFloat(latStr);
                    let lngVal = parseFloat(lngStr);
                    if(c.length < 5 || isNaN(latVal) || isNaN(lngVal)) return null;
                    return { 
                        id: i,
                        name:c[0], city:c[1], type:c[2], status:c[3], 
                        lat:latVal, lng:lngVal, link:c[6]||'',
                        nozzle: c[7] || '-', cost: c[8] || '-'
                    };
                }).filter(i=>i);

                renderList(); 
                if(txtNews) renderNews(txtNews);

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (p) => { 
                            userLat=p.coords.latitude; 
                            userLng=p.coords.longitude; 
                            processData(); 
                        },
                        (err) => {},
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                    );
                }
            } catch(e) {}
        }

        function enterApp(mode) {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 600);
            if(mode === 'sos') nav('sos');
        }

        function renderNews(csvText) {
            const rows = csvText.split('\n').slice(1);
            const container = document.getElementById('newsContainer');
            container.innerHTML = '';
            rows.forEach(r => {
                const cols = r.split(','); 
                if(cols.length < 3) return;
                let images = [];
                cols.forEach(val => { if(val.includes('http') && (val.includes('.jpg') || val.includes('.png') || val.includes('ibb'))) images.push(val); });

                let imgHTML = '';
                if(images.length > 0) {
                    imgHTML = `<div class="slide-container">`;
                    images.forEach(url => { imgHTML += `<div class="slide-box-multi"><img src="${url}"></div>`; });
                    imgHTML += `</div>`;
                    if(images.length > 1) imgHTML += `<div style="text-align:center;font-size:0.7rem;color:#666;margin-bottom:10px;">Geser untuk lihat foto lain</div>`;
                }
                container.innerHTML += `<div class="news-item">${imgHTML}<h3 style="color:var(--accent); margin-bottom:5px;">${cols[0]}</h3><p style="color:#aaa; font-size:0.85rem; margin-top:0;">${cols[1]}</p><p style="line-height:1.5; color:#ddd; font-size:0.9rem;">${cols[2]}</p></div>`;
            });
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
        }
        function getMapLink(i) {
            if(i.link && i.link.length > 10) return i.link;
            if(userLat) return `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${i.lat},${i.lng}&travelmode=motorcycle`;
            return `https://www.google.com/maps/search/?api=1&query=${i.lat},${i.lng}`;
        }

        function processData() {
            if(userLat) { 
                chargers.forEach(c => c.dist=parseFloat(getDist(userLat,userLng,c.lat,c.lng))); 
                chargers.sort((a,b)=> {
                    if(isNaN(a.dist)) return 1;
                    if(isNaN(b.dist)) return -1;
                    return a.dist-b.dist;
                });
            }
            
            if(chargers.length > 0) {
                const n = chargers[0];
                document.getElementById('scanState').style.display = 'none';
                document.getElementById('foundState').style.display = 'flex';
                
                document.getElementById('heroName').innerText = n.name;
                document.getElementById('heroDist').innerText = n.dist.toFixed(1) + ' KM';
                document.getElementById('heroInfo').innerText = `${n.city} â€¢ ${n.type}\n${n.nozzle} Nozzle â€¢ ${n.cost}`;
                document.getElementById('heroLink').href = getMapLink(n);
                // hijack hero link to open internal map first (but href kept as fallback)
                document.getElementById('heroLink').onclick = (e) => { e.preventDefault(); openMap(n.lat, n.lng, n.name); };

                renderList();
            }
        }

        function renderList() {
            const listCont = document.getElementById('mainListContainer');
            // Simpan scroll
            let scrollState = {};
            document.querySelectorAll('.city-group').forEach(group => {
                const title = group.querySelector('.city-title').innerText;
                scrollState[title] = group.querySelector('.h-scroll').scrollLeft;
            });

            listCont.innerHTML = ''; 
            let grouped = {};
            for(let i=0; i<chargers.length; i++) {
                let item = chargers[i];
                let city = item.city || 'Lainnya';
                if(!grouped[city]) grouped[city] = [];
                grouped[city].push(item);
            }

            let colorIdx = 0;
            Object.keys(grouped).forEach(city => {
                let groupHTML = `
                <div class="city-group">
                    <div class="city-header"><div class="city-title">${city}</div><div class="city-line"></div></div>
                    <div class="h-scroll">`;
                
                grouped[city].forEach(item => {
                    let styleClass = `style-${(colorIdx % 3) + 1}`;
                    colorIdx++;
                    // use JSON.stringify to safely embed name
                    groupHTML += `
                    <a href="${getMapLink(item)}" target="_blank" class="mini-card ${styleClass}" onclick="openMap(${item.lat}, ${item.lng}, ${JSON.stringify(item.name)}); return false;">
                        <div class="bg-bolt">âš¡</div>
                        <div class="mini-top"><h3>${item.name}</h3><div class="mini-info">${item.type}<br>${item.nozzle} Nozzle â€¢ ${item.cost}</div></div>
                        <div class="mini-bot"><div class="mini-dist">${item.dist ? item.dist.toFixed(1)+' KM' : ''}</div></div>
                    </a>`;
                });
                groupHTML += `</div></div>`;
                listCont.innerHTML += groupHTML;
            });

            // Restore scroll
            document.querySelectorAll('.city-group').forEach(group => {
                const title = group.querySelector('.city-title').innerText;
                if(scrollState[title]) group.querySelector('.h-scroll').scrollLeft = scrollState[title];
            });
        }

        function nav(p) {
            document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));
            if(p==='news') document.getElementById('modal-news').classList.add('show');
            if(p==='sos') document.getElementById('modal-sos').classList.add('show');
        }
        function closeModal() {
            document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));
        }

        function animateText(id, txt, delay) {
            const el = document.getElementById(id);
            el.innerHTML = txt.split('').map(l => `<span class="letter">${l===' '?' ':l}</span>`).join('');
            const letters = el.querySelectorAll('.letter');
            let i=0; return new Promise(r=>{ const t=setInterval(()=>{ if(i<letters.length){letters[i].classList.add('active');i++}else{clearInterval(t);r()} }, delay) });
        }
        
        // =========================
        // Map functions
        // =========================
        function getTileLayer() {
            if (JAWG_TOKEN && JAWG_TOKEN.trim().length > 5) {
                return L.tileLayer(`https://tile.jawg.io/jawg-sunny/{z}/{x}/{y}.png?access-token=${JAWG_TOKEN}`, {
                    maxZoom: 22,
                    attribution: '&copy; Jawg &copy; OSM'
                });
            } else {
                // fallback: Carto Voyager (no key)
                return L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    attribution: '&copy; Carto &copy; OSM'
                });
            }
        }

        function openMap(lat, lng, name) {
            // show overlay
            const overlay = document.getElementById('mapOverlay');
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
            document.getElementById('mapTitle').innerText = (name || 'Lokasi');

            // set open in google maps link
            const gmapUrl = (userLat ? `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}&travelmode=motorcycle` : `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`);
            const openG = document.getElementById('openGmapBtn');
            openG.href = gmapUrl;

            // init map
            if(!map) {
                // create map inside mapInner
                map = L.map('mapInner', { zoomControl: true });
                // tile
                getTileLayer().addTo(map);
                markerLayer = L.layerGroup().addTo(map);
            }

            // clear markers
            markerLayer.clearLayers();

            // dest marker
            destMarker = L.marker([lat, lng]).addTo(markerLayer).bindPopup(name || 'Tujuan').openPopup();

            // user marker if available
            if(userLat && userLng) {
                // small pulsing div icon
                const userDiv = L.divIcon({ html: '<div style="width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(204,255,0,0.9)"></div>', className:'' , iconSize:[14,14], iconAnchor:[7,7] });
                userMarker = L.marker([userLat, userLng], { icon: userDiv }).addTo(markerLayer).bindPopup('Lokasimu');
            } else {
                // try to get a one-time location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p=>{
                        userLat = p.coords.latitude;
                        userLng = p.coords.longitude;
                        const userDiv = L.divIcon({ html: '<div style="width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(204,255,0,0.9)"></div>', className:'' , iconSize:[14,14], iconAnchor:[7,7] });
                        userMarker = L.marker([userLat, userLng], { icon: userDiv }).addTo(markerLayer).bindPopup('Lokasimu');
                        fitMapBounds();
                    }, err=>{
                        // fallback: just set view on destination
                        map.setView([lat, lng], 14);
                    }, { enableHighAccuracy:true, timeout:5000 });
                } else {
                    map.setView([lat, lng], 14);
                }
            }

            fitMapBounds();

            // wire close button
            document.getElementById('mapCloseBtn').onclick = closeMap;
            // pressing ESC should close
            document.addEventListener('keydown', escHandler);
        }

        function fitMapBounds() {
            const coords = [];
            if (userLat && userLng) coords.push([userLat, userLng]);
            if (destMarker) coords.push([destMarker.getLatLng().lat, destMarker.getLatLng().lng]);
            if (coords.length === 1) {
                map.setView(coords[0], 14);
            } else if (coords.length > 1) {
                map.fitBounds(coords, { padding: [70,70] });
            }
        }

        function closeMap() {
            const overlay = document.getElementById('mapOverlay');
            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');
            document.removeEventListener('keydown', escHandler);
        }

        function escHandler(e) {
            if (e.key === 'Escape') closeMap();
        }

        // =========================
        // intro & startup
        // =========================
        async function runIntro() {
            await animateText('animText1', "SELAMAT DATANG", 40);
            await animateText('animText2', "SAHABAT MLU", 30);
            document.getElementById('animText3').style.opacity = '1'; 
            setTimeout(() => { document.querySelector('.loader-actions').classList.add('show'); }, 500);
            loadDataBackground();
        }
        runIntro();

        // ensure heroLink no default navigation (we set onclick in processData)
        document.getElementById('heroLink').addEventListener('click', (e)=>{ e.preventDefault(); });

    </script>
</body>
</html>
