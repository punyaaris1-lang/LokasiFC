<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>MLU Super App</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050a14">
    <link rel="apple-touch-icon" href="mlu-logo.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-dark: #050a14;
            --neon-blue: #00f3ff;
            --deep-blue: #2979ff;
            --danger: #ff2a6d;
            --text: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; 
            background: linear-gradient(180deg, #020408 0%, #0a1525 100%);
            color: var(--text); font-family: 'Rajdhani', sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
        }

        /* BACKGROUND LOGO TENGAH (WATERMARK) */
        .bg-watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: auto; opacity: 0.1; z-index: 0; pointer-events: none;
        }

        /* === HEADER GENERAL === */
        .header { 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(5, 10, 20, 0.9); border-bottom: 1px solid #222; z-index: 50; 
        }
        .header h1 { font-family: 'Orbitron'; font-size: 1.4rem; margin: 0; line-height: 1.1; color: #fff; }
        .label-top { font-size: 0.65rem; color: #888; font-weight: bold; letter-spacing: 1px; margin-bottom: 2px; }
        
        .top-controls { display: flex; gap: 10px; }
        .toggle-btn { 
            background: #111; border: 1px solid #333; padding: 5px 12px; border-radius: 20px; 
            color: #888; font-size: 0.7rem; font-weight: bold; cursor: pointer; 
        }
        .toggle-btn.active { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); }
        .btn-home-mini { font-size: 1.2rem; cursor: pointer; color: #fff; text-decoration: none; }

        /* === VIEWS === */
        .view-section { flex: 1; overflow-y: auto; display: none; position: relative; z-index: 10; padding-bottom: 20px; }
        .view-section.active { display: block; }

        /* === HOME STYLE (Sesuai Gambar 1000248874.jpg) === */
        .home-wrap { padding: 30px 25px; display: flex; flex-direction: column; height: 100%; justify-content: center; }
        .app-title { text-align: center; margin-bottom: 30px; }
        .app-title h1 { font-family: 'Orbitron'; font-size: 2.5rem; color: var(--neon-blue); text-shadow: 0 0 20px var(--deep-blue); margin: 0; }
        .app-badge { background: var(--deep-blue); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; margin-top: 5px; font-family: 'Orbitron'; }

        .menu-list { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .menu-btn { 
            background: rgba(15, 25, 40, 0.8); border: 1px solid var(--deep-blue); 
            padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; 
            cursor: pointer; transition: 0.2s; 
        }
        .menu-btn:active { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.1); }
        .menu-icon { width: 45px; height: 45px; background: rgba(0,0,0,0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #fff; border: 1px solid #333; }
        .menu-txt h3 { margin: 0; font-family: 'Orbitron'; font-size: 1rem; color: #fff; }
        .menu-txt span { font-size: 0.7rem; color: #aaa; }

        .mitra-wrap { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; }
        .mitra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .mitra-box { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: center; color: #fff; text-decoration: none; font-size: 0.8rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        /* === LIST FC STYLE (Sesuai Gambar 1000248871.jpg & 1000248797.jpg) === */
        #fc-list-view { padding: 20px; }
        
        /* HERO NEAREST */
        .hero-box { 
            background: rgba(10, 20, 30, 0.9); border: 1px solid var(--neon-blue); 
            border-radius: 15px; padding: 20px; margin-bottom: 25px; position: relative; 
        }
        .dist-tag { position: absolute; top: 15px; right: 15px; border: 1px solid var(--neon-blue); padding: 4px 10px; border-radius: 8px; font-family: 'Orbitron'; font-size: 0.85rem; color: var(--neon-blue); }
        .hero-title { font-family: 'Orbitron'; font-size: 1.4rem; color: #fff; margin: 10px 0 5px 0; }
        .hero-desc { font-size: 0.8rem; color: #aaa; margin-bottom: 15px; border-left: 3px solid var(--neon-blue); padding-left: 10px; }
        .btn-full { width: 100%; padding: 12px; background: var(--neon-blue); color: #000; border: none; border-radius: 10px; font-weight: bold; font-family: 'Orbitron'; cursor: pointer; }

        /* GRID LOKASI (FIXED HEIGHT & ALIGNMENT) */
        .city-label { font-family: 'Orbitron'; color: #fff; margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.9rem; }
        .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } /* Grid 2 Kolom */
        .loc-card { 
            background: linear-gradient(145deg, #0b101a, #161b22); border: 1px solid #333; border-radius: 15px; 
            padding: 15px; display: flex; flex-direction: column; justify-content: space-between; 
            height: 200px; /* KUNCI TINGGI */
        }
        .loc-icon { font-size: 1.2rem; color: var(--neon-blue); margin-bottom: 5px; }
        .loc-name { font-family: 'Orbitron'; font-size: 0.85rem; line-height: 1.3; margin-bottom: 5px; color: #fff; }
        .loc-sub { font-size: 0.65rem; color: #888; }
        .loc-footer { margin-top: auto; width: 100%; }
        .loc-dist { text-align: right; font-weight: bold; font-size: 0.8rem; color: var(--neon-blue); margin-bottom: 5px; }
        .btn-go { width: 100%; background: var(--neon-blue); border: none; padding: 6px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; cursor: pointer; font-family: 'Orbitron'; }

        /* MAP FULLSCREEN */
        #map-view { width: 100%; height: 100%; position: relative; }
        #fullMap { width: 100%; height: 100%; }
        .btn-map-back { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 999; background: #000; border: 1px solid var(--neon-blue); color: #fff; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-family: 'Orbitron'; }

        /* === ANTRIAN STYLE (Sesuai Gambar 1000248794.jpg) === */
        #antrian-view { padding: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-label { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--neon-blue); display: block; margin-bottom: 5px; }
        .custom-input { width: 100%; background: #080f1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; text-align: center; font-family: 'Rajdhani'; font-size: 1.1rem; outline: none; }
        .custom-input:focus { border-color: var(--neon-blue); }

        /* SLOT BATERAI */
        .slot-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 20px 0; }
        .slot-box { background: rgba(10,20,30,0.8); border: 1px solid #333; border-radius: 12px; padding: 10px 5px; text-align: center; min-height: 160px; display: flex; flex-direction: column; align-items: center; }
        .slot-box.active { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0,243,255,0.1); }
        
        .bat-shape { width: 30px; height: 50px; border: 2px solid #666; border-radius: 4px; position: relative; display: flex; align-items: flex-end; padding: 2px; margin: 10px auto; }
        .slot-box.active .bat-shape { border-color: #fff; }
        .bat-shape::before { content:''; position: absolute; top:-5px; left:6px; width:14px; height:3px; background:#666; }
        .bat-level { width: 100%; background: var(--neon-blue); border-radius: 2px; transition: height 0.5s; box-shadow: 0 0 5px var(--neon-blue); }

        .slot-btn { width: 100%; margin-top: auto; padding: 5px; font-size: 0.65rem; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; }
        .btn-start { background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue); }
        .btn-stop { background: var(--danger); color: #fff; }
        .btn-done { background: var(--neon-blue); color: #000; } /* Tombol Selesai */

        /* DASHBOARD STATUS */
        .queue-stats { text-align: center; border: 1px solid var(--deep-blue); border-radius: 12px; padding: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.5); }
        .q-count { font-size: 2rem; font-weight: 800; font-family: 'Orbitron'; color: #fff; text-shadow: 0 0 10px var(--neon-blue); }

        .queue-list-item { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 10px 0; align-items: center; }
        .q-del-btn { color: #555; cursor: pointer; font-size: 1.2rem; }

        /* ADMIN PANEL */
        #adminPanel { display: none; border: 1px solid var(--danger); padding: 15px; border-radius: 10px; margin-top: 20px; position: relative; background: #000; }
        .close-adm { position: absolute; top: 5px; right: 10px; color: var(--danger); font-weight: bold; cursor: pointer; }
        .adm-btn { width: 100%; padding: 10px; margin-top: 8px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-box { background: #0b101a; border: 1px solid var(--neon-blue); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; }
        
        /* INFO LIST STYLE */
        .info-item { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .info-title { font-family: 'Orbitron'; color: var(--neon-blue); font-size: 0.9rem; margin-bottom: 5px; }
        .info-body { font-size: 0.8rem; color: #ccc; line-height: 1.4; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <audio id="alarm" loop preload="auto"><source src="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mp3"></audio>
    <div id="loader"><div style="color:var(--neon-blue); font-family:'Orbitron';">LOADING...</div></div>
    
    <img src="mlu-logo.png" class="bg-watermark">

    <div id="view-home" class="view-section active">
        <div class="home-wrap">
            <div class="app-title">
                <h1>MLU APPS</h1>
                <div class="app-badge">MAKA LINTAS UTARA SQUAD</div>
            </div>

            <div class="menu-list">
                <div class="menu-btn" onclick="nav('list')">
                    <div class="menu-icon">üìç</div>
                    <div class="menu-txt"><h3>LOKASI FC</h3><span>Cari Charging Station</span></div>
                </div>
                <div class="menu-btn" onclick="openModal('sos')">
                    <div class="menu-icon" style="color:var(--danger); border-color:var(--danger);">üÜò</div>
                    <div class="menu-txt"><h3 style="color:var(--danger);">MAKA SOS</h3><span>Layanan Darurat</span></div>
                </div>
                <div class="menu-btn" onclick="nav('queue')">
                    <div class="menu-icon">‚ö°</div>
                    <div class="menu-txt"><h3>ANTRIAN</h3><span>Daftar & Pantau</span></div>
                </div>
            </div>

            <div class="mitra-wrap">
                <div style="font-family:'Orbitron'; font-size:0.7rem; color:var(--neon-blue);">MITRA CHARGING</div>
                <div class="mitra-grid">
                    <a href="https://casan.id" target="_blank" class="mitra-box"><span>üîå</span>CASAN.ID</a>
                    <a href="https://play.google.com/store/apps/details?id=com.starvo" target="_blank" class="mitra-box"><span>üì±</span>STARVO</a>
                </div>
                <div class="mitra-box" style="margin-top:10px; width:100%; cursor:pointer;" onclick="openModal('news')">üì∞ INFO & EVENT MLU</div>
            </div>
            <div style="text-align:center; font-size:0.7rem; color:#555; margin-top:auto;">&copy; MLU 2025</div>
        </div>
    </div>

    <div id="view-list" class="view-section">
        <div class="header">
            <div>
                <div class="label-top">LOKASI</div>
                <h1>FAST CHARGING</h1>
            </div>
            <div class="top-controls">
                <div class="toggle-btn active">‚ò∞ LIST</div>
                <div class="toggle-btn" onclick="nav('map')">üó∫Ô∏è PETA</div>
                <div class="btn-home-mini" onclick="nav('home')">üè†</div>
            </div>
        </div>

        <div id="fc-list-container">
            <div id="heroContainer" style="padding:0 20px;"></div> <div id="listContent" style="padding:0 20px;"></div> </div>
    </div>

    <div id="view-map" class="view-section" style="height:100%; padding:0;">
        <button class="btn-map-back" onclick="nav('list')">‚¨Ö KEMBALI KE LIST</button>
        <div id="fullMap"></div>
    </div>

    <div id="view-queue" class="view-section">
        <div class="header">
            <div onclick="nav('home')" style="cursor:pointer; border:1px solid var(--neon-blue); padding:5px 15px; border-radius:20px; color:var(--neon-blue); font-weight:bold; font-size:0.8rem;">‚¨Ö HOME</div>
            <h1 style="font-size:1.2rem;">ANTRIAN</h1>
            <div style="width:50px;"></div>
        </div>

        <div class="q-container" style="padding:20px;">
            <div class="glass-card" style="background:rgba(10,20,30,0.8); border:1px solid #333; padding:15px; border-radius:15px; margin-bottom:20px;">
                <div class="input-group">
                    <label class="input-label">PLAT NOMOR</label>
                    <input id="uPlat" class="custom-input" placeholder="B 1234 XYZ" oninput="this.value=this.value.toUpperCase()">
                </div>
                <div class="input-group">
                    <label class="input-label">WHATSAPP</label>
                    <input id="uWa" type="number" class="custom-input" placeholder="08xxxxxxxxxx">
                </div>
                <div class="input-group">
                    <label class="input-label">BATERAI (%)</label>
                    <input id="uBat" type="number" class="custom-input" placeholder="0 - 99" oninput="if(this.value>99)this.value=99">
                </div>
                <button id="btnDaftar" class="btn-full" style="margin-top:10px;">DAFTAR ANTRIAN</button>
                <div id="locStatus" style="text-align:center; font-size:0.7rem; margin-top:5px; color:#888;"></div>
            </div>

            <div class="slot-row" id="slots"></div>

            <div class="queue-stats">
                <div style="font-size:0.7rem; color:#aaa; letter-spacing:1px; margin-bottom:5px;">DAFTAR TUNGGU</div>
                <div id="qCount" class="q-count">0 ANTRIAN</div>
                <div id="limitInfo" style="font-size:0.7rem; background:var(--neon-blue); color:#000; padding:2px 8px; border-radius:4px; display:inline-block; font-weight:bold; margin-top:5px;">MAX: 100%</div>
            </div>

            <div id="qList"></div>

            <div style="text-align:center; margin-top:30px; cursor:pointer; opacity:0.5;" onclick="showAdmin()">üîí ADMIN PANEL</div>

            <div id="adminPanel">
                <div class="close-adm" onclick="document.getElementById('adminPanel').style.display='none'">‚úï</div>
                <h4 style="color:var(--danger); text-align:center; margin-top:0;">MASTER CONTROL</h4>
                <select id="mSlot" class="custom-input" style="text-align:left; margin-bottom:5px;"><option value="0">Slot 3 (Kiri)</option><option value="1">Slot 2 (Tengah)</option><option value="2">Slot 1 (Kanan)</option></select>
                <button onclick="clrSlot()" class="adm-btn" style="background:#333; color:#fff;">HAPUS SLOT</button>
                <button onclick="blockUser()" class="adm-btn" style="background:var(--danger); color:#fff;">BLOKIR PLAT</button>
                <button onclick="resAll()" class="adm-btn" style="border:1px solid var(--danger); background:transparent; color:var(--danger);">RESET TOTAL</button>
            </div>
        </div>
    </div>

    <div id="modal-sos" class="modal"><div class="modal-box"><h3 style="color:var(--danger);">DARURAT (SOS)</h3><a href="https://wa.me/6287722285445" class="menu-btn" style="margin-top:15px; color:#fff; text-decoration:none;">üöë TOWING / MOGOK</a><a href="https://wa.me/6283179721893" class="menu-btn" style="margin-top:10px; color:#fff; text-decoration:none;">üö® URC KECELAKAAN</a><button onclick="closeModal()" class="adm-btn" style="margin-top:15px;">TUTUP</button></div></div>
    
    <div id="modal-news" class="modal">
        <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
            <h3 style="margin-bottom:15px;">INFO & EVENT</h3>
            <div id="newsContainer">Loading...</div>
            <button onclick="closeModal()" class="adm-btn" style="margin-top:15px;">TUTUP</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const FIREBASE_CFG = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const LOC_DATA_URL = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv"; 
        const NEWS_API = "https://docs.google.com/spreadsheets/d/1qh_aKEQQvN0B1E6ONO0LGIpuQ6phzc-ALc4SduClMyY/export?format=csv";
        const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
        const MAX_DIST = 200; 

        let userLat=null, userLng=null, chargers=[], map=null, wakeLock=null;

        window.onload = () => {
            document.getElementById('loader').style.display='none';
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw-baru.js');
            initFirebase(); loadNews(); loadLocs();
            if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{userLat=p.coords.latitude; userLng=p.coords.longitude; calcDist();}, null, {enableHighAccuracy:true});
            nav('home');
        };

        function nav(id) {
            document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.modal').forEach(el=>el.classList.remove('show'));
            document.getElementById('view-'+id).classList.add('active');
            if(id==='queue') requestWakeLock();
            if(id==='map') setTimeout(()=>{if(map)map.invalidateSize()}, 300);
        }
        function openModal(id) { document.getElementById('modal-'+id).classList.add('show'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show')); }
        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }

        // === LOCATION ===
        async function loadLocs() {
            try {
                const t = await fetch(LOC_DATA_URL).then(r=>r.text());
                chargers = t.split('\n').slice(1).map((r,i) => {
                    const c = r.split(','); let lat=parseFloat(c[4]), lng=parseFloat(c[5]);
                    if(isNaN(lat)) return null;
                    return { id:i, name:c[0], city:c[1], type:c[2], lat:lat, lng:lng, dist:999, nozzle: c[7]||'-', cost: c[8]||'Gratis' };
                }).filter(i=>i);
                renderList();
            } catch(e){}
        }
        function calcDist() {
            if(!userLat) return;
            chargers.forEach(c => {
                const R=6371; const dLat=(c.lat-userLat)*Math.PI/180; const dLon=(c.lng-userLng)*Math.PI/180;
                const a=Math.sin(dLat/2)**2+Math.cos(userLat*Math.PI/180)*Math.cos(c.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                c.dist = (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
            });
            chargers.sort((a,b)=>a.dist-b.dist);
            renderList();
        }
        function renderList() {
            if(chargers.length===0) return;
            const n = chargers[0]; // Nearest
            document.getElementById('heroContainer').innerHTML = `
                <div class="hero-box">
                    <div class="dist-tag">${n.dist} KM</div>
                    <div class="radar-status blink-me"><div class="gps-dot"></div> FC TERDEKAT</div>
                    <div class="hero-title">${n.name}</div>
                    <div class="hero-desc">${n.city} ‚Ä¢ ${n.type}<br>${n.nozzle} Nozzle ‚Ä¢ ${n.cost}</div>
                    <button class="btn-full" onclick="showMap(${n.lat},${n.lng},'${n.name}')">LIHAT DI PETA</button>
                </div>`;
            
            let html = '<div class="loc-grid">';
            chargers.slice(1).forEach(c => {
                html += `
                <div class="loc-card">
                    <div>
                        <div class="loc-icon">‚ö°</div>
                        <div class="loc-name">${c.name}</div>
                        <div class="loc-sub">${c.type}</div>
                    </div>
                    <div class="loc-footer">
                        <div class="loc-dist">${c.dist} KM</div>
                        <button class="btn-go" onclick="showMap(${c.lat},${c.lng},'${c.name}')">GO ‚Üó</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('listContent').innerHTML = html;
        }

        // === MAP ===
        function showMap(lat, lng, name) {
            nav('map');
            if(!map) {
                map = L.map('fullMap').setView([lat, lng], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            } else { map.setView([lat, lng], 15); }
            
            // Clear markers
            map.eachLayer((layer) => { if(layer instanceof L.Marker) map.removeLayer(layer); });

            // Target Marker
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`<div style="text-align:center;"><b>${name}</b><br><a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=two_wheeler" target="_blank" style="color:blue; font-weight:bold;">NAVIGASI GOOGLE MAPS ‚Üó</a></div>`)
                .openPopup();
            
            // User Marker
            if(userLat) {
                L.marker([userLat, userLng]).addTo(map).bindPopup("LOKASI ANDA");
            }
        }

        // === NEWS ===
        async function loadNews() {
            try { 
                const t = await fetch(NEWS_API).then(r=>r.text()); 
                const rows = t.split('\n').slice(1).map(x=>x.split(',')); 
                let h = '';
                rows.forEach(c => { 
                    if(c.length>2) {
                        h += `<div class="info-item"><div class="info-title">${c[0]}</div><div class="info-body">${c[2]}</div></div>`;
                    }
                }); 
                document.getElementById('newsContainer').innerHTML = h;
            } catch(e){} 
        }

        // === QUEUE SYSTEM ===
        function getDynamicLimit(count) { if(count > 10) return 85; if(count >= 6) return 90; if(count >= 3) return 95; return 100; }
        function getDuration(startBat, limit) { let total = 0; for(let i=startBat; i<limit; i++) { if(i<80) total += 0.8; else if(i<90) total += 1.1; else total += 1.8; } return Math.ceil(total); }

        function initFirebase() {
            if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CFG);
            const db = firebase.firestore(); const ref = db.collection("antrian").doc("utama");
            const aud = document.getElementById('alarm'); const SLOT_NAMES = ["SLOT 3", "SLOT 2", "SLOT 1"]; let triggered = new Set();

            // DAFTAR
            document.getElementById('btnDaftar').onclick = () => {
                aud.play().then(() => aud.pause()).catch(e=>{});
                const p = document.getElementById('uPlat').value.toUpperCase().trim(); const w = document.getElementById('uWa').value; const b = parseInt(document.getElementById('uBat').value);
                if(!p || !w || isNaN(b)) return alert('Isi semua data!');
                if(!userLat) return alert('Tunggu GPS...');
                
                // Cek Jarak Simple
                const dist = Math.sqrt(Math.pow(STATION_LOC.lat-userLat,2) + Math.pow(STATION_LOC.lng-userLng,2)) * 111000;
                if(dist > MAX_DIST) return alert(`Kejauhan! Jarak: ${dist.toFixed(0)}m. Max: ${MAX_DIST}m.`);

                db.runTransaction(async t => {
                    const d = (await t.get(ref)).data() || {};
                    let s = d.chargingSlots || [null,null,null]; let q = d.waitingQueue || [];
                    if(s.some(x=>x?.name===p) || q.some(x=>x?.name===p)) throw "Sudah terdaftar!";
                    
                    let empty = s.findIndex(x=>!x);
                    let limit = getDynamicLimit(q.length);
                    let dur = getDuration(b, limit);

                    if(empty !== -1) s[empty] = { name:p, phone:w, startBattery:b, target:limit, startTime:null, duration:dur }; 
                    else q.push({ name:p, phone:w, startBattery:b, target:100, duration:0 }); 
                    
                    t.set(ref, {chargingSlots:s, waitingQueue:q}, {merge:true});
                }).then(()=>{ alert('Berhasil!'); localStorage.setItem('myPlat', p); }).catch(e=>alert(e));
            };

            // SNAPSHOT
            ref.onSnapshot(snap => {
                const d = snap.data() || {}; const s = d.chargingSlots || [null,null,null]; const q = d.waitingQueue || [];
                document.getElementById('qCount').innerText = `${q.length} ANTRIAN`;
                document.getElementById('limitInfo').innerText = `MAX: ${getDynamicLimit(q.length)}%`;

                // Render Queue List
                document.getElementById('qList').innerHTML = q.length===0 ? '<div style="text-align:center;color:#555;font-size:0.7rem;">- Kosong -</div>' : q.map((x,i)=>`<div class="queue-list-item"><div><b style="color:#fff;">${x.name}</b> <span style="font-size:0.7rem; color:#888;">${x.startBattery}%</span></div><div class="q-del-btn" onclick="delQ(${i},'${x.name}')">üóë</div></div>`).join('');

                // Render Slots
                document.getElementById('slots').innerHTML = s.map((x,i) => {
                    if(!x) return `<div class="slot-box"><div style="font-size:0.6rem; color:#888;">${SLOT_NAMES[i]}</div><div class="bat-shape"></div><div style="margin-top:auto; font-size:0.7rem; color:var(--neon-blue);">READY</div></div>`;
                    
                    const isRun = !!x.startTime; let txt = isRun ? "MENGISI" : "MENUNGGU"; let h = x.startBattery;
                    if(isRun) {
                        let start = x.startTime.toMillis ? x.startTime.toMillis() : new Date(x.startTime).getTime();
                        let end = start + (x.duration*60000);
                        if(Date.now() > end) { 
                            txt = "SELESAI"; 
                            if(!triggered.has(x.name) && localStorage.getItem('myPlat')===x.name) { triggered.add(x.name); aud.play(); navigator.vibrate(1000); }
                        }
                    }
                    // TOMBOL AKSI
                    let btn = "";
                    if(isRun) {
                        if(txt === "SELESAI") btn = `<button class="slot-btn btn-done" onclick="act(${i},'stop')">SELESAI</button>`;
                        else btn = `<button class="slot-btn btn-stop" onclick="act(${i},'stop')">STOP</button>`;
                    } else {
                        btn = `<button class="slot-btn btn-start" onclick="act(${i},'start')">START</button>`;
                    }

                    return `<div class="slot-box active"><div style="font-size:0.6rem; color:#888;">${SLOT_NAMES[i]}</div><div class="bat-shape"><div class="bat-level" style="height:${h}%"></div></div><div style="font-weight:bold; color:#fff; font-size:0.8rem; margin-top:5px;">${x.name}</div><div style="font-size:0.65rem; margin-bottom:5px; color:#ccc;">${txt}</div>${btn}</div>`;
                }).join('');
            });

            // LOGIC AUTO UP
            window.act = (i, type) => { 
                db.runTransaction(async t => { 
                    const d = (await t.get(ref)).data(); let s = d.chargingSlots; let q = d.waitingQueue; 
                    if(type==='stop') { 
                        s[i] = null; 
                        // JIKA ADA ANTRIAN, LANGSUNG NAIK
                        if(q.length > 0) {
                            let next = q.shift();
                            let limit = getDynamicLimit(q.length);
                            next.duration = getDuration(next.startBattery, limit);
                            next.target = limit;
                            s[i] = next; // Masuk slot tapi status belum start (User baru harus tekan START sendiri)
                        }
                    } else { s[i].startTime = new Date(); } 
                    t.update(ref, {chargingSlots:s, waitingQueue:q}); 
                }); 
            };
            
            window.delQ=(i,n)=>{ if(confirm("Hapus antrian ini?")) db.runTransaction(async t=>{const q=(await t.get(ref)).data().waitingQueue;q.splice(i,1);t.update(ref,{waitingQueue:q})}); };
            window.showAdmin=()=>{ let p=prompt("PIN:"); if(p==='1131') document.getElementById('adminPanel').style.display='block'; };
            window.clrSlot=()=>{const i=document.getElementById('mSlot').value; db.runTransaction(async t=>{const s=(await t.get(ref)).data().chargingSlots;s[i]=null;t.update(ref,{chargingSlots:s})});};
            window.blockUser=()=>{/*Logic Blokir Simple*/ alert("Fitur Blokir Aktif");};
            window.resAll=()=>{if(confirm('RESET TOTAL?')) ref.set({chargingSlots:[null,null,null],waitingQueue:[]});};
        }
    </script>
</body>
</html>
